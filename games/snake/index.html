<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>贪吃蛇</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* === 贪吃蛇专用样式 === */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-user-select: none; }
        
        body {
            background-color: #2c241e; /* 和主站一致的深棕色 */
            color: #d7c8b8;
            font-family: 'Courier New', monospace; /* 复古字体 */
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* 1. 顶部标题 */
        .game-header {
            height: 50px;
            background-color: #3c322a;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        /* 2. 游戏屏幕区域 (中间) */
        .screen-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        /* 复古屏幕外框 */
        .retro-screen-bezel {
            background-color: #5e5044;
            padding: 15px;
            border-radius: 10px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
        }

        /* 实际的游戏画布 */
        canvas {
            background-color: #9ab09a; /* 经典的 GameBoy 绿屏幕 */
            display: block;
            border: 2px solid #4a3f35;
            image-rendering: pixelated; /* 像素化渲染 */
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }

        /* 屏幕上的菜单遮罩 (开始/皮肤/排行) */
        .screen-menu {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            z-index: 10;
        }
        .screen-menu.hidden { display: none; }

        .menu-btn {
            background: #e6a23c;
            border: 2px solid #fff;
            color: #2c241e;
            padding: 10px 20px;
            font-family: inherit;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            width: 160px;
            text-transform: uppercase;
            box-shadow: 0 4px 0 #b37e2e; /* 立体按钮效果 */
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .menu-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #b37e2e;
        }

        /* 3. 虚拟按键区域 (底部) */
        .controls-area {
            height: 40%; /* 给按键留足空间 */
            background-color: #3c322a;
            border-top: 2px solid #5e5044;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 20px;
            flex-shrink: 0;
        }

        /* 十字键布局 */
        .d-pad {
            display: grid;
            grid-template-columns: 60px 60px 60px;
            grid-template-rows: 60px 60px;
            gap: 10%;
        }
        
        .d-btn {
            width: 60px; height: 60px;
            background-color: #2c241e;
            border: 2px solid #5e5044;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: #95a5a6;
            box-shadow: 0 4px 0 #1a1a1a;
            cursor: pointer;
        }
        .d-btn:active {
            transform: translateY(4px);
            box-shadow: none;
            background-color: #1a1a1a;
            color: #e6a23c;
        }

        /* 布局占位 */
        .d-up { grid-column: 2; grid-row: 1; }
        .d-left { grid-column: 1; grid-row: 2; }
        .d-down { grid-column: 2; grid-row: 2; }
        .d-right { grid-column: 3; grid-row: 2; }

        /* 功能键区域 (冲刺) */
        .action-pad {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .action-btn {
            width: 70px; height: 70px;
            border-radius: 50%;
            background-color: #c0392b; /* 红色按钮 */
            border: 4px solid #922b21;
            box-shadow: 0 5px 0 #641e16;
            display: flex;
            justify-content: center;
            align-items: center;
            color: rgba(255,255,255,0.8);
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
        }
        .action-btn:active {
            transform: translateY(5px);
            box-shadow: none;
            filter: brightness(1.1);
        }
        .action-label { font-size: 12px; color: #95a5a6; }

        /* 分数显示 */
        .score-board {
            position: absolute;
            top: 10%;
            right: 10%;
            color: #2c241e;
            font-weight: bold;
            z-index: 5;
        }

    </style>
</head>
<body>

    <!-- 1. 顶部标题 -->
    <div class="game-header">
        Dionysus Felicitas
    </div>

    <!-- 2. 屏幕区域 -->
    <div class="screen-container">
        <div class="retro-screen-bezel">
            <div class="score-board">SCORE: <span id="score">0</span></div>
            
            <!-- 游戏画布 -->
            <canvas id="gameCanvas" width="300" height="300"></canvas>

            <!-- 菜单遮罩 -->
            <div id="menuOverlay" class="screen-menu">
                <h2 style="color:#2c241e; text-shadow: 2px 2px 0 #fff;">SNAKE</h2>
                <button class="menu-btn" onclick="startGame()">开始游戏</button>
                <button id="skinBtn" class="menu-btn" onclick="changeSkin()">更换皮肤</button>

                <button class="menu-btn" onclick="alert('暂无记录')">查看排行榜</button>
                <button class="menu-btn" onclick="exitGame()">退出游戏</button>
            </div>
            
            <!-- 游戏结束遮罩 -->
            <div id="gameOverOverlay" class="screen-menu hidden">
                <h2 style="color:#c0392b; text-shadow: 2px 2px 0 #fff;">GAME OVER</h2>
                <p style="color:#cea688; font-weight:bold;">得分: <span id="finalScore">0</span></p>
                <button class="menu-btn" onclick="resetGame()">再来一局</button>
                <button class="menu-btn" onclick="showMainMenu()">返回菜单</button>
            </div>
        </div>
    </div>

    <!-- 3. 虚拟按键区域 -->
    <div class="controls-area">
        <!-- 方向键 -->
        <div class="d-pad">
            <div class="d-btn d-up" id="btnUp"><i class="fas fa-caret-up"></i></div>
            <div class="d-btn d-left" id="btnLeft"><i class="fas fa-caret-left"></i></div>
            <div class="d-btn d-down" id="btnDown"><i class="fas fa-caret-down"></i></div>
            <div class="d-btn d-right" id="btnRight"><i class="fas fa-caret-right"></i></div>
        </div>

        <!-- 冲刺键 -->
        <div class="action-pad">
            <div class="action-btn" id="btnDash">DASH</div>
            <span class="action-label">加速</span>
        </div>
    </div>



    <script>
         // === 皮肤配置 ===
        const skins = {
            default: {
                name: "复古经典",
                bg: '#9ab09a',      // 屏幕背景：经典绿
                snake: '#2c241e',   // 蛇身：深棕
                head: '#000000',    // 蛇头：黑
                apple: '#c0392b',   // 苹果：红
                isRound: false      // 苹果形状：方形
            },
            christmas: {
                name: "圣诞快乐",
                bg: '#144235',      // 屏幕背景：圣诞树深绿
                snake: '#ffffff',   // 蛇身：雪白
                head: '#c0392b',    // 蛇头：圣诞帽红
                apple: '#f1c40f',   // 苹果：金色铃铛/星星
                isRound: true       // 苹果形状：圆形 (像装饰球)
            }
        };

        let currentSkinKey = 'default'; // 当前使用的皮肤
        // === 贪吃蛇 游戏逻辑 ===
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const finalScoreEl = document.getElementById('finalScore');
        
        // 游戏配置
        const gridSize = 15; // 每个格子的大小
        const tileCount = canvas.width / gridSize; // 一行有多少个格子 (20个)
        
        let speed = 7; // 初始速度 (每秒帧数)
        let score = 0;
        let gameLoop;
        let isGameRunning = false;
        let isDash = false; // 是否在冲刺

        // 蛇的状态
        let headX = 10;
        let headY = 10;
        let velocityX = 0;
        let velocityY = 0;
        let snakeParts = [];
        let tailLength = 2;

        // 食物的位置
        let appleX = 5;
        let appleY = 5;

        // === 核心功能 ===

        function startGame() {
            document.getElementById('menuOverlay').classList.add('hidden');
            document.getElementById('gameOverOverlay').classList.add('hidden');
            resetVars();
            isGameRunning = true;
            drawGame();
        }

        function resetVars() {
            headX = 10; headY = 10;
            velocityX = 0; velocityY = 0;
            snakeParts = [];
            tailLength = 2;
            score = 0;
            speed = 7;
            scoreEl.innerText = score;
            placeApple();
        }

        function resetGame() {
            startGame();
        }

        function showMainMenu() {
            document.getElementById('gameOverOverlay').classList.add('hidden');
            document.getElementById('menuOverlay').classList.remove('hidden');
            isGameRunning = false;
            clearTimeout(gameLoop);
        }

        // === 新增：退出游戏逻辑 ===
        function exitGame() {
            // 调用父窗口(主页)的 closeGame 函数
            if (window.parent && window.parent.closeGame) {
                window.parent.closeGame();
            } else {
                // 如果是单独打开的网页，无法关闭，提示一下
                alert("请直接关闭浏览器标签页");
            }
        }

        // === 游戏循环 ===
        function drawGame() {
            if (!isGameRunning) return;

            changeSnakePosition();
            let result = isGameOver();
            if (result) return;

            clearScreen();
            checkAppleCollision();
            drawApple();
            drawSnake();
            
            // 冲刺时速度加倍
            let currentSpeed = isDash ? speed * 2 : speed;
            
            gameLoop = setTimeout(drawGame, 1000 / currentSpeed);
        }

                function isGameOver() {
            let gameOver = false;

            // === 1. 撞墙检测 ===
            if (headX < 0 || headX === tileCount || headY < 0 || headY === tileCount) {
                gameOver = true;
            }

            // === 2. 撞自己检测 ===
            // 【修复关键】：如果蛇是静止的 (velocityX 和 velocityY 都是 0)，
            // 说明刚开始游戏，这时候不要检测撞自己，否则会秒挂。
            if (velocityX === 0 && velocityY === 0) {
                return false;
            }

            for (let i = 0; i < snakeParts.length; i++) {
                let part = snakeParts[i];
                // 只有当身体部分真的和头重叠时才算输
                if (part.x === headX && part.y === headY) {
                    gameOver = true;
                    break;
                }
            }

            if (gameOver) {
                finalScoreEl.innerText = score;
                document.getElementById('gameOverOverlay').classList.remove('hidden');
                isGameRunning = false;
            }
            return gameOver;
        }


        function clearScreen() {
            // 使用当前皮肤的背景色
            ctx.fillStyle = skins[currentSkinKey].bg; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function drawSnake() {
            // 使用当前皮肤的蛇身颜色
            ctx.fillStyle = skins[currentSkinKey].snake; 
            for (let i = 0; i < snakeParts.length; i++) {
                let part = snakeParts[i];
                ctx.fillRect(part.x * gridSize, part.y * gridSize, gridSize - 2, gridSize - 2);
            }

            // 把头加进去
            snakeParts.push(new SnakePart(headX, headY));
            while (snakeParts.length > tailLength) {
                snakeParts.shift(); 
            }

            // 使用当前皮肤的蛇头颜色
            ctx.fillStyle = skins[currentSkinKey].head; 
            ctx.fillRect(headX * gridSize, headY * gridSize, gridSize - 2, gridSize - 2);
        }

        function changeSnakePosition() {
            headX = headX + velocityX;
            headY = headY + velocityY;
        }

        function drawApple() {
            ctx.fillStyle = skins[currentSkinKey].apple;
            
            // 圣诞皮肤特供：苹果变成圆形的装饰球
            if (skins[currentSkinKey].isRound) {
                ctx.beginPath();
                // 计算圆心位置
                let centerX = appleX * gridSize + gridSize / 2;
                let centerY = appleY * gridSize + gridSize / 2;
                let radius = (gridSize - 2) / 2;
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.fill();
            } else {
                // 经典皮肤：方形苹果
                ctx.fillRect(appleX * gridSize, appleY * gridSize, gridSize - 2, gridSize - 2);
            }
        }

        function checkAppleCollision() {
            if (appleX === headX && appleY === headY) {
                appleX = Math.floor(Math.random() * tileCount);
                appleY = Math.floor(Math.random() * tileCount);
                tailLength++;
                score++;
                scoreEl.innerText = score;
                // 稍微增加一点难度
                if(score % 5 === 0) speed += 0.5;
            }
        }

        function placeApple() {
            appleX = Math.floor(Math.random() * tileCount);
            appleY = Math.floor(Math.random() * tileCount);
        }

        class SnakePart {
            constructor(x, y) {
                this.x = x;
                this.y = y;
            }
        }

        // === 控制逻辑 ===
        
        // 键盘控制
        document.body.addEventListener('keydown', keyDown);
        document.body.addEventListener('keyup', keyUp);

        function keyDown(event) {
            // 冲刺键 (Shift 或 Space)
            if (event.code === 'Space' || event.code === 'ShiftLeft') {
                isDash = true;
            }

            // 方向键
            // 只有当蛇已经在移动时，才禁止反向移动
            // 初始状态 velocityX=0, velocityY=0 时允许任意方向
            if (event.keyCode === 38) { // Up
                if (velocityY === 1) return;
                velocityY = -1; velocityX = 0;
            }
            if (event.keyCode === 40) { // Down
                if (velocityY === -1) return;
                velocityY = 1; velocityX = 0;
            }
            if (event.keyCode === 37) { // Left
                if (velocityX === 1) return;
                velocityY = 0; velocityX = -1;
            }
            if (event.keyCode === 39) { // Right
                if (velocityX === -1) return;
                velocityY = 0; velocityX = 1;
            }
        }

        function keyUp(event) {
            if (event.code === 'Space' || event.code === 'ShiftLeft') {
                isDash = false;
            }
        }

                function changeSkin() {
            // 切换逻辑：如果是默认就变圣诞，如果是圣诞就变默认
            if (currentSkinKey === 'default') {
                currentSkinKey = 'christmas';
            } else {
                currentSkinKey = 'default';
            }

            // 找到按钮，更新按钮文字，提示当前皮肤
            const skinBtn = document.getElementById('skinBtn');
            skinBtn.innerText = "皮肤: " + skins[currentSkinKey].name;

            // 如果游戏没在运行，手动重画一次屏幕，让玩家立刻看到背景变了
            if (!isGameRunning) {
                clearScreen();
                // 简单画个蛇和苹果示意一下
                ctx.fillStyle = skins[currentSkinKey].snake;
                ctx.fillRect(10 * gridSize, 10 * gridSize, gridSize - 2, gridSize - 2);
                ctx.fillStyle = skins[currentSkinKey].apple;
                ctx.fillRect(5 * gridSize, 5 * gridSize, gridSize - 2, gridSize - 2);
            }
        }


        // === 虚拟按键绑定 ===
        // 使用 touchstart 和 mousedown 保证手机和电脑都能点
        function bindBtn(id, action) {
            const btn = document.getElementById(id);
            const startAction = (e) => { e.preventDefault(); action(); };
            btn.addEventListener('mousedown', startAction);
            btn.addEventListener('touchstart', startAction);
        }

        bindBtn('btnUp', () => { if (velocityY !== 1) { velocityY = -1; velocityX = 0; } });
        bindBtn('btnDown', () => { if (velocityY !== -1) { velocityY = 1; velocityX = 0; } });
        bindBtn('btnLeft', () => { if (velocityX !== 1) { velocityY = 0; velocityX = -1; } });
        bindBtn('btnRight', () => { if (velocityX !== -1) { velocityY = 0; velocityX = 1; } });

        // 冲刺按钮特殊处理 (按下加速，松开恢复)
        const dashBtn = document.getElementById('btnDash');
        const startDash = (e) => { e.preventDefault(); isDash = true; };
        const endDash = (e) => { e.preventDefault(); isDash = false; };

        dashBtn.addEventListener('mousedown', startDash);
        dashBtn.addEventListener('touchstart', startDash);
        dashBtn.addEventListener('mouseup', endDash);
        dashBtn.addEventListener('touchend', endDash);

    </script>
</body>
</html>
